<p>FOTA/Wireless Programming for Funky V3</p>
<p><br /></p>
<p><span lang="zxx">I wanted to have </span><a href="http://en.wikipedia.org/wiki/Over-the-air_programming"><span lang="zxx">FOTA</span></a><span lang="zxx">/</span><a href="http://lowpowerlab.com/blog/category/moteino/wireless-programming/"><span lang="zxx">Wireless programming</span></a><span lang="zxx"> capability for my project. Unfortunately </span><a href="https://github.com/LowPowerLab/RFM69"><span lang="zxx">RFM</span></a><a href="https://github.com/LowPowerLab/RFM69"><span lang="zxx">69 </span></a><a href="https://github.com/LowPowerLab/RFM69"><span lang="zxx">library</span></a><span lang="zxx"> does not fit 4kB </span><a href="http://www.hackersworkbench.com/intro-to-bootloaders-for-avr"><span lang="zxx">bootloader</span></a><span lang="zxx"> area therefore I could not follow </span><a href="http://www.engineersgarage.com/embedded/avr-microcontroller-projects/How-to-Use-SPM-for-Flash-to-Flash-Programming"><span lang="zxx">standard self-programming mechanism</span></a><span lang="zxx"> (store data comming from a serial stream to internal flash). I wanted to reuse </span><a href="https://github.com/LowPowerLab/WirelessProgramming"><span lang="zxx">Felix's wireless programming library</span></a><span lang="zxx"> however </span><a href="http://harizanov.com/wiki/wiki-home/funky-v3/"><span lang="zxx">F</span></a><a href="http://harizanov.com/wiki/wiki-home/funky-v3/"><span lang="zxx">unky </span></a><a href="http://harizanov.com/wiki/wiki-home/funky-v3/"><span lang="zxx">V3</span></a><span lang="zxx"> does not have external </span><a href="http://www.instructables.com/id/How-to-Design-with-Discrete-SPI-Flash-Memory/"><span lang="zxx">spi flash</span></a><span lang="zxx">. Therefore I had to change layout of the internal 32kB flash. </span><span lang="zxx">I was influenced by video: </span><a href="https://www.youtube.com/watch?v=jbLy6kE-Szg"><span lang="zxx">Intermediate memory bootloaders</span></a><span style="display: inline-block; border: none; padding: 0cm"><span lang="zxx"><span style="background: transparent">.</span></span></span></p>
<p><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">Standard layout for atmega32u4 with Caterina bootloader has two main sections. The </span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">application</span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal"> </span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">s</span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">ection </span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">(aps) </span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">0x0000-0x6</span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">FFF</span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal"> </span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">(28KB) </span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">and bootloader </span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">s</span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">ection </span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">(bls) </span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">0x7000-0x7</span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">FFF</span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal"> </span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">(4KB)</span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">. </span></span></span></span></p>
<p><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">I split ap</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">s</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"> into two equal areas. First is </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">an </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">app area 0x0000-0x37</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">FF</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"> </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">(14KB) and</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"> the rest 0x3800-0x7</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">FFF</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"> </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">(14KB) </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">is something like external spi flash area, let's call it temp area. The first disadvantage is clear </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">we have only 14KB </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">instead of 28</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">K</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">B for our </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">application code</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">. To be honest it is even worst. </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"><span style="background: #ffff00">12</span></span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"><span style="background: #ffff00">K</span></span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"><span style="background: #ffff00">B </span></span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">o</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">ut of 14</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">K</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">B is occupied by RFM69 driver and wireless programing code. The bottom line is that we have around </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"><span style="background: #ffff00">1</span></span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"><span style="background: #ffff00">K</span></span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"><span style="background: #ffff00">B</span></span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"> for our app. </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">It</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"> may seem to be ridiculous</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">ly small </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">but it is sufficient for my app that is supposed to count led flashes on my watt-meter and send them via </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">RFM</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">69 </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">to </span></span></span></span></span><a href="https://wiki.openenergymonitor.org/index.php/RFM69Pi_V3"><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">RFM69PI V3</span></span></span></span></span></a><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"> gateway for further processing</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">. Later on I would like to measure other thin</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">g</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">s </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">such as temperature </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">voltage</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"> of </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">battery</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">, … </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">and I don't have easy access to </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">F</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">unky </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">node</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"> therefore </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">FOTA</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"> is needed.</span></span></span></span></span></p>
<h1 class="western" lang="zxx">Changes in Bootloader</h1>
<ul>
<li></li>
</ul>
<ul>
<li></li>
</ul>
<p><br /></p>
<p>The only remaining piece is the update of temp area with firmware coming over the air.</p>
<h1 class="western" lang="zxx">Changes in Wireless Programming Library</h1>
<p>Modified wireless programming library writes firmware coming from the air into temp area instead of external spi flash. I removed all debugging messages to shrink size of this library in favor of space for application code.</p>
<h1 class="western" lang="zxx">Layout of Flash Memory</h1>
<p>0x0000 – 0x37FF Application code (app area) 14KB=14336B</p>
<p>0x3800 – 0x3801 Length of data in temp area (if value &gt;14334 means temp area contains invalid data</p>
<p>0x3802 – 0x6FFF Temp area 14334B</p>
<p>0x7000 – 0x7FFF Bootloader area 4096B (bls)</p>
<h1 class="western" lang="zxx">Complete Flow of FOTA Process</h1>
<ol>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
</ol>
<h1 class="western" lang="zxx">Potential Improvements</h1>
<p><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">v</span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">erification of checksum of firmware prior to update of app area.</span></span></span></span></p>
<p><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">m</span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">ore space in the app area, </span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">there are several techniques how to get there</span></span></span></span></p>
<ul>
<li></li>
<li></li>
<li></li>
</ul>
<p><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">i</span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">ntroduce </span></span></span></span></span><a href="http://lowpowerlab.com/blog/2016/01/21/wireless-programming-just-got-50-faster/"><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">faster mode</span></span></span></span></span></a><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal"> that </span></span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span lang="zxx"><span style="font-style: normal"><span style="font-weight: normal">increases transfer rate</span></span></span></span></span></p>
<p><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">a</span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">llow </span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">A</span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">rduino </span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">IDE</span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal"> to update firmware over </span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">the </span></span></span></span><span style="font-variant: normal"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal">air</span></span></span></span></p>
